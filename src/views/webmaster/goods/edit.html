<!DOCTYPE html>

<html>
<head>
    <title>Edit Goods - Electronic Commerce Platform</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    {{template "styles"}}
    <link href="/statics/thirdpart/uploadify/uploadify.css" rel="stylesheet" />
    <style>
        .edit-category-tmp{margin-right: 10px;}
        .uploadify-img{width: 120px;height: 120px;}
    </style>
</head>
<body>
    <div id="leftside">
        {{template "leftside" .}}
    </div>

    <div id="rightside">

        <div class="main">

            <a href="javascript:void(0);" onclick="history.back(-1)"><span class="glyphicon glyphicon-arrow-left"></span> Back</a>

            <h3>Edit Goods</h3>

            <form class="edit-form">
                <div class="form-group">
                    <label for="EditTitle">Title</label>
                    <input type="text" class="form-control" id="EditTitle" disabled="disabled" />
                </div>
                <div class="form-group">
                    <label for="EditCategory">Category</label>
                    <input type="hidden" id="EditCategory" value="" />
                    <div class="form-inline edit-category">

                    </div>
                </div>
                <div class="form-group">
                    <label for="EditRecommend">Recommend</label>
                    <textarea class="form-control" id="EditRecommend" placeholder="Enter the recommend statements"></textarea>
                </div>
                <div class="form-group">
                    <label for="EditContent">Content</label>
                    <textarea class="form-control" id="EditContent"></textarea>
                </div>
                <div class="form-group">
                    <label for="EditOrigin">Origin</label>
                    <input type="text" class="form-control" id="EditOrigin" />
                    <!--<select class="form-control" id="EditOrigin">
                        {{range $index, $item := .OriginList}}
                        <option>{{$item.Name}}</option>
                        {{end}}
                    </select>-->
                </div>
                <div class="form-group">
                    <label for="EditUnit">Unit</label>
                    <input type="text" class="form-control" id="EditUnit" placeholder="Enter unit, eg: 1公斤、150克、1袋" />
                </div>
                <div class="form-group">
                    <label for="EditPrice">Price</label>
                    <input type="text" class="form-control" id="EditPrice" placeholder="Enter price, eg: 199.00" />
                </div>
                <div class="form-group">
                    <label for="EditShop">Shop</label>
                    <input type="text" class="form-control" id="EditShop" placeholder="Enter shop name, eg: 广州稻草人" />
                </div>
                <div class="form-group">
                    <label for="EditBuyLink">BuyLink</label>
                    <input type="text" class="form-control" id="EditBuyLink" placeholder="Enter buy link, eg: http://gzdcr.com" />
                </div>
                <div class="form-group">
                    <label for="EditImages">Images</label>
                    <textarea class="form-control" id="EditImages"></textarea>
                    <table class="table">
                        <thead>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    Group
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_1"></span>
                                    (420*390)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_2"></span>
                                    (420*390)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_3"></span>
                                    (420*390)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_4"></span>
                                    (420*390)
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Size
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_5"></span>
                                    (60*60)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_6"></span>
                                    (180*180)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_7"></span>
                                    (250*250)
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_8"></span>
                                    (380*240)
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="form-group">
                    <label for="EditCertificates">Certificates</label>
                    <textarea class="form-control" id="EditCertificates"></textarea>
                    <table class="table">
                        <thead>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    Group
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_9"></span>
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_10"></span>
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_11"></span>
                                </td>
                                <td>
                                    <img src="" class="uploadify-img" />
                                    <span id="uploadify_12"></span>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td></td><td></td><td></td><td></td><td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="form-group">
                    <label for="EditStatus">Status</label>
                    <select class="form-control" id="EditStatus">
                        {{range $key, $value := .GoodsStatusMap}}
                        <option value="{{$key}}">{{$value}}</option>
                        {{end}}
                    </select>
                </div>

                <input type="hidden" id="EditId" />
                <button type="button" class="btn btn-primary" onclick="SubmitEditForm()">Submit</button>
                <button type="button" class="btn btn-default" onclick="InitForm()">Reset</button>
            </form>

        </div>
    </div>

    <div class="clear"></div>

    {{template "scripts"}}
    <script src="http://cdn.bootcss.com/ckeditor/4.4.2/ckeditor.js"></script>
    <script src="http://cdn.bootcss.com/ckeditor/4.4.2/adapters/jquery.min.js"></script>
    <script src="/statics/thirdpart/uploadify/jquery.uploadify-3.2.min.js"></script>
    <script>
        // 分类列表的json对象
        var o = JSON.parse({{.JsonCategoryList}});
        // 用于存放图片组的json对象
        var imageUrl = JSON.parse({{.Goods.Images}});
        // 用于存放证书的json对象
        var certificatesUrl = JSON.parse({{.Goods.Certificates}})

        $(function(){
            InitSelect({{.Goods.Category}});
            InitForm();
            InitCKEditor();
            InitImages();

            // 组图和大小图
            uploadify($('#uploadify_1'), "group_1")
            uploadify($('#uploadify_2'), "group_2")
            uploadify($('#uploadify_3'), "group_3")
            uploadify($('#uploadify_4'), "group_4")
            uploadify($('#uploadify_5'), "mini")
            uploadify($('#uploadify_6'), "small")
            uploadify($('#uploadify_7'), "medium")
            uploadify($('#uploadify_8'), "large")

            // 证书等
            uploadify($('#uploadify_9'), "cer_1")
            uploadify($('#uploadify_10'), "cer_2")
            uploadify($('#uploadify_11'), "cer_3")
            uploadify($('#uploadify_12'), "cer_4")

        });

        function InitImages(){
            $('#uploadify_1').prev().attr("src", imageUrl.group_1);
            $('#uploadify_2').prev().attr("src", imageUrl.group_2);
            $('#uploadify_3').prev().attr("src", imageUrl.group_3);
            $('#uploadify_4').prev().attr("src", imageUrl.group_4);
            $('#uploadify_5').prev().attr("src", imageUrl.mini);
            $('#uploadify_6').prev().attr("src", imageUrl.small);
            $('#uploadify_7').prev().attr("src", imageUrl.medium);
            $('#uploadify_8').prev().attr("src", imageUrl.large);

            $('#uploadify_9').prev().attr("src", certificatesUrl.cer_1);
            $('#uploadify_10').prev().attr("src", certificatesUrl.cer_2);
            $('#uploadify_11').prev().attr("src", certificatesUrl.cer_3);
            $('#uploadify_12').prev().attr("src", certificatesUrl.cer_4);
        }

        // 加载uploadify
        function uploadify(obj, key) {
            var upload_dir = "goods/{{.Goods.Id}}/";
            obj.uploadify({
                uploader: '/uploadprocess/webmaster/uploadify?dir=' + upload_dir,
                swf: '/statics/thirdpart/uploadify/uploadify.swf',
                //width: 50,
                //height: 25,
                buttonText: "上传",
                buttonCursor: 'hand',
                fileObjName: 'upload',
                fileTypeExts: '*.jpg;*.png;*.gif',
                fileTypeDesc: "请选择 jpg png gif 文件",
                auto: true,
                multi: false,
                onUploadSuccess: function (file, data, response) {
                    var o = JSON.parse(data);
                    if (o.status == "0") {
                        if (key == "group_1"){
                            imageUrl.group_1 = o.url;
                            $('#uploadify_1').prev().attr("src", o.url);
                        } else if (key == "group_2") {
                            imageUrl.group_2 = o.url;
                            $('#uploadify_2').prev().attr("src", o.url);
                        } else if (key == "group_3") {
                            imageUrl.group_3 = o.url;
                            $('#uploadify_3').prev().attr("src", o.url);
                        } else if (key == "group_4") {
                            imageUrl.group_4 = o.url;
                            $('#uploadify_4').prev().attr("src", o.url);
                        } else if (key == "mini") {
                            imageUrl.mini = o.url;
                            $('#uploadify_5').prev().attr("src", o.url);
                        } else if (key == "small") {
                            imageUrl.small = o.url;
                            $('#uploadify_6').prev().attr("src", o.url);
                        } else if (key == "medium") {
                            imageUrl.medium = o.url;
                            $('#uploadify_7').prev().attr("src", o.url);
                        } else if (key == "large") {
                            imageUrl.large = o.url;
                            $('#uploadify_8').prev().attr("src", o.url);
                        } else if (key == "cer_1") {
                            certificatesUrl.cer_1 = o.url;
                            $('#uploadify_9').prev().attr("src", o.url);
                        } else if (key == "cer_2") {
                            certificatesUrl.cer_2 = o.url;
                            $('#uploadify_10').prev().attr("src", o.url);
                        } else if (key == "cer_3") {
                            certificatesUrl.cer_3 = o.url;
                            $('#uploadify_11').prev().attr("src", o.url);
                        } else if (key == "cer_4") {
                            certificatesUrl.cer_4 = o.url;
                            $('#uploadify_12').prev().attr("src", o.url);
                        }
                        $('#EditImages').val(JSON.stringify(imageUrl));
                        $('#EditCertificates').val(JSON.stringify(certificatesUrl));
                    }
                }
            });
        }

        // 初始化CKEditor
        function InitCKEditor(){
            // 先设置上传目录
            var upload_dir = "goods/{{.Goods.Id}}/";
            $('#EditContent').ckeditor({
                height: '450',
                toolbar: [
                    { name: 'document', items: ['Source', '-', 'Preview', 'Print', '-'] },
                    { name: 'clipboard', items: ['Cut', 'Copy', 'Paste', 'PasteText', 'PasteFromWord', '-', 'Undo', 'Redo'] },
                    { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'Subscript', 'Superscript'] },
                    { name: 'insert', items: ['Image', 'Table', 'HorizontalRule', 'Smiley', 'SpecialChar', 'PageBreak'] },
                    { name: 'links', items: ['Link', 'Unlink', 'Anchor'] },
                    '/',
                    { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock', '-', 'BidiLtr', 'BidiRtl'] },
                    { name: 'styles', items: ['Styles', 'Format', 'Font', 'FontSize'] },
                    { name: 'colors', items: ['TextColor', 'BGColor'] }
                ],
                image_previewText: ' ',
                filebrowserImageUploadUrl: '/uploadprocess/webmaster/ckeditor?dir=' + upload_dir
            });
        }

        // 初始化表单
        function InitForm(){
            $('#EditId').val({{.Goods.Id}});
            $('#EditTitle').val({{.Goods.Title}});
            $('#EditCategory').val({{.Goods.Category}});
            $('#EditRecommend').val({{.Goods.Recommend}});
            $('#EditContent').val({{.Goods.Content}});
            $('#EditOrigin').val({{.Goods.Origin}});
            $('#EditUnit').val({{.Goods.Unit}});
            $('#EditPrice').val({{.Goods.Price}});
            $('#EditShop').val({{.Goods.Shop}});
            $('#EditBuyLink').val({{.Goods.BuyLink}});
            $('#EditImages').val({{.Goods.Images}});
            $('#EditCertificates').val({{.Goods.Certificates}});
            $('#EditStatus').val({{.Goods.Status}});
        }

        // 初始化下拉列表
        function InitSelect(root){
            // 递归出口，如果root的父结点为空，则跳出；否则进行递归
            if(root == "") {
                return;
            }
            var parent = "";
            for(var i=0; i < o.length; i ++){
                if(o[i].name == root){
                    parent = o[i].parent;
                    InitSelect(parent);
                    break;
                }
            }
            // 能到这来说明它有父节点
            var container = $('.edit-category');
            var options = '<option value="">请选择</option>';
            // 从json对象生成添加表单的下拉列表数据
            for(var i=0; i < o.length; i ++){
                if(o[i].parent == parent){
                    if(o[i].name == root){
                        options += '<option selected="selected">' + o[i].name + '</option>';
                    }else {
                        options += '<option>' + o[i].name + '</option>';
                    }
                }
            }
            var select = '<select class="form-control edit-category-tmp" onchange="LoadChildrenSelect(this);">' + options + '</select>';
            container.append(select);
            // 如果当前结点为叶结点，则加上标记
            var flag = false;
            for(var i = 0; i < o.length; i ++){
                if(o[i].parent == root){
                    flag = true;
                    break;
                }
            }
            if(!flag){
                container.append('<label><span class="glyphicon glyphicon-ok-sign text-success"></span></label>');
                $('#EditCategory').val(root);
            }
        }

        // 加载子下拉列表
        function LoadChildrenSelect(sel) {
            $(sel).nextAll().remove();
            var root = $(sel).val();
            if (root == "") {
                $('#EditCategory').val("");
                return
            }
            // 从json对象生成添加表单的下拉列表数据
            var options = "";
            for (var i = 0; i < o.length; i++) {
                if (o[i].parent == root) {
                    options += "<option>" + o[i].name + "</option>";
                }
            }
            if (options != "") {
                options = '<option value="">请选择</option>' + options;
                var select = '<select class="form-control edit-category-tmp" onchange="LoadChildrenSelect(this);">' + options + '</select>';
                $(sel).after(select);
                $('#CreateCategory').val("");
            } else {
                $(sel).after('<label><span class="glyphicon glyphicon-ok-sign text-success"></span></label>');
                $('#EditCategory').val(root);
            }
        }

        // 提交表单
        function SubmitEditForm(){
            var id = $('#EditId').val();
            var title = $('#EditTitle').val();
            var category = $('#EditCategory').val();
            var recommend = $('#EditRecommend').val();
            var content = $('#EditContent').val();
            var origin = $('#EditOrigin').val();
            var unit = $('#EditUnit').val();
            var price = $('#EditPrice').val();
            var shop = $('#EditShop').val();
            var buylink = $('#EditBuyLink').val();
            var images = $('#EditImages').val();
            var certificates = $('#EditCertificates').val();
            var status = $('#EditStatus').val();

            // 表单验证
            if (title == ""){
                alert("Title could not be empty")
                return
            }
            if (category == ""){
                alert("Category could not be empty")
                return
            }

            $.ajax({
                type: 'POST',
                url: '/webmaster/goods/edit',
                data: {
                    id: id,
                    title: title,
                    category: category,
                    recommend: recommend,
                    content: content,
                    origin: origin,
                    unit: unit,
                    price: price,
                    shop: shop,
                    buylink: buylink,
                    images: images,
                    certificates: certificates,
                    status: status
                },
                success: function(data) {
                    location.reload();
                },
                dataType: 'text'
            });
        }
    </script>
</body>
</html>